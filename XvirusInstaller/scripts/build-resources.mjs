import { execSync } from 'child_process';
import { readFileSync, writeFileSync, existsSync, mkdirSync, rmSync } from 'fs';
import { dirname, join } from 'path';
import { fileURLToPath } from 'url';

const __dirname = dirname(fileURLToPath(import.meta.url));
const projectRoot = join(__dirname, '..');
const mode = process.argv[2] || 'am';

if (mode !== 'am' && mode !== 'fw') {
  console.error('Invalid mode. Use: node build-resources.mjs [am|fw]');
  process.exit(1);
}

const resourcesDir = join(projectRoot, 'resources');
const generatedDir = join(projectRoot, 'src', 'generated');
const zipPath = join(projectRoot, 'resources.zip');

// Ensure generated directory exists
if (!existsSync(generatedDir)) {
  mkdirSync(generatedDir, { recursive: true });
}

// Product info based on mode
const productInfo = {
  am: {
    mode: 'am',
    name: 'Xvirus Anti-Malware',
    installFolder: 'Xvirus Anti-Malware',
    uiExeName: 'XvirusAM.exe',
    serviceName: 'XvirusAntiMalwareService',
    serviceDescription: 'Xvirus Anti-Malware Protection Service',
    version: '8.0.0',
    publisher: 'Xvirus',
  },
  fw: {
    mode: 'fw',
    name: 'Xvirus Firewall',
    installFolder: 'Xvirus Firewall',
    uiExeName: 'XvirusFW.exe',
    serviceName: 'XvirusFirewallService',
    serviceDescription: 'Xvirus Firewall Protection Service',
    version: '5.0.0',
    publisher: 'Xvirus',
  },
};

const product = productInfo[mode];

console.log(`Building installer for: ${product.name}`);

// Check if resources directory exists and has files
if (!existsSync(resourcesDir)) {
  console.error(`Error: resources directory not found at ${resourcesDir}`);
  console.error('Please place your build artifacts in the resources/ folder:');
  console.error('  - Xvirus.exe (renamed from xvirus-firewall-win_x64.exe)');
  console.error('  - resources.neu');
  console.error('  - XvirusService.exe');
  console.error('  - unin.exe');
  process.exit(1);
}

const resourceFiles = execSync(`dir /b "${resourcesDir}"`, { encoding: 'utf-8' })
  .split('\n')
  .filter((f) => f.trim());

if (resourceFiles.length === 0) {
  console.error(`Error: resources directory is empty: ${resourcesDir}`);
  console.error('Please place your build artifacts in the resources/ folder');
  process.exit(1);
}

console.log(`Found ${resourceFiles.length} files in resources/:`);
resourceFiles.forEach((f) => console.log(`  - ${f}`));

// Create zip using PowerShell
console.log('Creating zip file...');
try {
  execSync(
    `powershell -Command "Compress-Archive -Path '${resourcesDir}\\*' -DestinationPath '${zipPath}' -Force"`,
    {
      encoding: 'utf-8',
    },
  );
} catch (error) {
  console.error('Error creating zip:', error.message);
  process.exit(1);
}

// Read and base64-encode zip
console.log('Encoding resources as base64...');
const zipBuffer = readFileSync(zipPath);
const base64 = zipBuffer.toString('base64');

console.log(`Zip size: ${(zipBuffer.length / 1024 / 1024).toFixed(2)} MB`);
console.log(`Base64 size: ${(base64.length / 1024 / 1024).toFixed(2)} MB`);

// Generate TypeScript file
const tsContent = `// Auto-generated by build-resources.mjs - DO NOT EDIT
// Mode: ${mode}
// Generated: ${new Date().toISOString()}

export const RESOURCES_B64 = "${base64}";

export const PRODUCT_INFO = {
  mode: "${product.mode}",
  name: "${product.name}",
  installFolder: "${product.installFolder}",
  uiExeName: "${product.uiExeName}",
  serviceName: "${product.serviceName}",
  serviceDescription: "${product.serviceDescription}",
  version: "${product.version}",
  publisher: "${product.publisher}"
} as const;

export type ProductInfo = typeof PRODUCT_INFO;
`;

writeFileSync(join(generatedDir, 'resources.ts'), tsContent);

// Cleanup
rmSync(zipPath, { force: true });

console.log(`✓ Resources embedded in src/generated/resources.ts`);
console.log(`✓ Mode: ${mode} (${product.name})`);
